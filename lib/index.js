'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var cls = require('continuation-local-storage');
var clsBluebird = require('cls-bluebird');

var ns = cls.createNamespace('bookshelf-sessions');
var TRANSACTION_KEY = 'trx';

var getCurrentTransaction = function getCurrentTransaction() {
  return ns.get(TRANSACTION_KEY);
};

var isUnderTransaction = function isUnderTransaction() {
  return getCurrentTransaction() !== undefined;
};

var withTransaction = function withTransaction() {
  var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

  if (isUnderTransaction()) {
    return _extends({
      transacting: getCurrentTransaction()
    }, options);
  }
  return options;
};

module.exports = function (bookshelf) {
  // Patch Bluebird to work correctly with cls
  clsBluebird(ns);

  bookshelf.Model = bookshelf.Model.extend({
    save: function save(key, val, options) {
      var save = bookshelf.Model.__super__.save;

      if (key === null || key === undefined || (typeof key === 'undefined' ? 'undefined' : _typeof(key)) === "object") {
        return save.call(this, key, withTransaction(val));
      }

      return save.call(this, key, val, withTransaction(options));
    },
    destroy: function destroy(options) {
      return bookshelf.Model.__super__.destroy.call(this, withTransaction(options));
    },
    fetch: function fetch(options) {
      return bookshelf.Model.__super__.fetch.call(this, withTransaction(options));
    },
    fetchAll: function fetchAll(options) {
      return bookshelf.Model.__super__.fetchAll.call(this, withTransaction(options));
    },
    load: function load(relations, options) {
      return bookshelf.Model.__super__.load.call(this, relations, withTransaction(options));
    }
  });

  bookshelf.Collection = bookshelf.Collection.extend({
    attach: function attach(ids, options) {
      return bookshelf.Collection.__super__.attach.call(this, ids, withTransaction(options));
    },
    detach: function detach(ids, options) {
      return bookshelf.Collection.__super__.detach.call(this, ids, withTransaction(options));
    },
    create: function create(model, options) {
      return bookshelf.Collection.__super__.create.call(this, model, withTransaction(options));
    },
    fetchOne: function fetchOne(options) {
      return bookshelf.Collection.__super__.fetchOne.call(this, withTransaction(options));
    },
    load: function load(relations, options) {
      return bookshelf.Collection.__super__.load.call(this, relations, withTransaction(options));
    },
    updatePivot: function updatePivot(attributes, options) {
      return bookshelf.Collection.__super__.updatePivot.call(this, attributes, withTransaction(options));
    }
  });

  bookshelf._originalTransaction = bookshelf.transaction;

  bookshelf.transaction = function (callback) {
    return this._originalTransaction(function (trx) {
      return ns.runAndReturn(function () {
        ns.set(TRANSACTION_KEY, trx);
        return callback(trx);
      });
    });
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJjbHMiLCJyZXF1aXJlIiwiY2xzQmx1ZWJpcmQiLCJucyIsImNyZWF0ZU5hbWVzcGFjZSIsIlRSQU5TQUNUSU9OX0tFWSIsImdldEN1cnJlbnRUcmFuc2FjdGlvbiIsImdldCIsImlzVW5kZXJUcmFuc2FjdGlvbiIsInVuZGVmaW5lZCIsIndpdGhUcmFuc2FjdGlvbiIsIm9wdGlvbnMiLCJ0cmFuc2FjdGluZyIsIm1vZHVsZSIsImV4cG9ydHMiLCJib29rc2hlbGYiLCJNb2RlbCIsImV4dGVuZCIsInNhdmUiLCJrZXkiLCJ2YWwiLCJfX3N1cGVyX18iLCJjYWxsIiwiZGVzdHJveSIsImZldGNoIiwiZmV0Y2hBbGwiLCJsb2FkIiwicmVsYXRpb25zIiwiQ29sbGVjdGlvbiIsImF0dGFjaCIsImlkcyIsImRldGFjaCIsImNyZWF0ZSIsIm1vZGVsIiwiZmV0Y2hPbmUiLCJ1cGRhdGVQaXZvdCIsImF0dHJpYnV0ZXMiLCJfb3JpZ2luYWxUcmFuc2FjdGlvbiIsInRyYW5zYWN0aW9uIiwiY2FsbGJhY2siLCJydW5BbmRSZXR1cm4iLCJzZXQiLCJ0cngiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQU1BLE1BQU1DLFFBQVEsNEJBQVIsQ0FBWjtBQUNBLElBQU1DLGNBQWNELFFBQVEsY0FBUixDQUFwQjs7QUFFQSxJQUFNRSxLQUFLSCxJQUFJSSxlQUFKLENBQW9CLG9CQUFwQixDQUFYO0FBQ0EsSUFBTUMsa0JBQWtCLEtBQXhCOztBQUVBLElBQU1DLHdCQUF3QixTQUF4QkEscUJBQXdCO0FBQUEsU0FBTUgsR0FBR0ksR0FBSCxDQUFPRixlQUFQLENBQU47QUFBQSxDQUE5Qjs7QUFFQSxJQUFNRyxxQkFBcUIsU0FBckJBLGtCQUFxQjtBQUFBLFNBQU1GLDRCQUE0QkcsU0FBbEM7QUFBQSxDQUEzQjs7QUFFQSxJQUFNQyxrQkFBa0IsU0FBbEJBLGVBQWtCLEdBQWtCO0FBQUEsTUFBakJDLE9BQWlCLHVFQUFQLEVB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QVVhLFVBQVYsQ0FBcUJQLFNBQXJCLENBQStCYSxRQUEvQixDQUNKWixJQURJLENBQ0MsSUFERCxFQUNPWixnQkFBZ0JDLE9BQWhCLENBRFAsQ0FBUDtBQUVELEtBaEJnRDtBQWlCakRlLFVBQU0sY0FBVUMsU0FBVixFQUFxQmhCLE9BQXJCLEVBQThCO0FBQ2xDLGFBQU9JLFVBQVVhLFVBQVYsQ0FBcUJQLFNBQXJCLENBQStCSyxJQUEvQixDQUNKSixJQURJLENBQ0MsSUFERCxFQUNPSyxTQURQLEVBQ2tCakIsZ0JBQWdCQyxPQUFoQixDQURsQixDQUFQO0FBRUQsS0FwQmdEO0FBcUJqRHdCLGlCQUFhLHFCQUFVQyxVQUFWLEVBQXNCekIsT0FBdEIsRUFBK0I7QUFDMUMsYUFBT0ksVUFBVWEsVUFBVixDQUFxQlAsU0FBckIsQ0FBK0JjLFdBQS9CLENBQ0piLElBREksQ0FDQyxJQURELEVBQ09jLFVBRFAsRUFDbUIxQixnQkFBZ0JDLE9BQWhCLENBRG5CLENBQVA7QUFFRDtBQXhCZ0QsR0FBNUIsQ0FBdkI7O0FBMkJBSSxZQUFVc0Isb0JBQVYsR0FBaUN0QixVQUFVdUIsV0FBM0M7O0FBRUF2QixZQUFVdUIsV0FBVixHQUF3QixVQUFVQyxRQUFWLEVBQW9CO0FBQzFDLFdBQU8sS0FBS0Ysb0JBQUwsQ0FBMEI7QUFBQSxhQUMvQmxDLEdBQUdxQyxZQUFILENBQWdCLFlBQU07QUFDcEJyQyxXQUFHc0MsR0FBSCxDQUFPcEMsZUFBUCxFQUF3QnFDLEdBQXhCO0FBQ0EsZUFBT0gsU0FBU0csR0FBVCxDQUFQO0FBQ0QsT0FIRCxDQUQrQjtBQUFBLEtBQTFCLENBQVA7QUFNRCxHQVBEO0FBUUQsQ0FyRUQiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBjbHMgPSByZXF1aXJlKCdjb250aW51YXRpb24tbG9jYWwtc3RvcmFnZScpO1xuY29uc3QgY2xzQmx1ZWJpcmQgPSByZXF1aXJlKCdjbHMtYmx1ZWJpcmQnKTtcblxuY29uc3QgbnMgPSBjbHMuY3JlYXRlTmFtZXNwYWNlKCdib29rc2hlbGYtc2Vzc2lvbnMnKTtcbmNvbnN0IFRSQU5TQUNUSU9OX0tFWSA9ICd0cngnO1xuXG5jb25zdCBnZXRDdXJyZW50VHJhbnNhY3Rpb24gPSAoKSA9PiBucy5nZXQoVFJBTlNBQ1RJT05fS0VZKTtcblxuY29uc3QgaXNVbmRlclRyYW5zYWN0aW9uID0gKCkgPT4gZ2V0Q3VycmVudFRyYW5zYWN0aW9uKCkgIT09IHVuZGVmaW5lZDtcblxuY29uc3Qgd2l0aFRyYW5zYWN0aW9uID0gKG9wdGlvbnMgPSB7fSkgPT4ge1xuICBpZiAoaXNVbmRlclRyYW5zYWN0aW9uKCkpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHJhbnNhY3Rpbmc6IGdldEN1cnJlbnRUcmFuc2FjdGlvbigpLFxuICAgICAgLi4ub3B0aW9ucyxcbiAgICB9O1xuICB9XG4gIHJldHVybiBvcHRpb25zO1xufTtcblxuXG5tb2R1bGUuZXhwb3J0cyA9IChib29rc2hlbGYpID0+IHtcbiAgLy8gUGF0Y2ggQmx1ZWJpcmQgdG8gd29yayBjb3JyZWN0bHkgd2l0aCBjbHNcbiAgY2xzQmx1ZWJpcmQobnMpO1xuXG4gIGJvb2tzaGVsZi5Nb2RlbCA9IGJvb2tzaGVsZi5Nb2RlbC5leHRlbmQoe1xuICAgIHNhdmU6IGZ1bmN0aW9uIChrZXksIHZhbCwgb3B0aW9ucykge1xuICAgICAgY29uc3Qgc2F2ZSA9IGJvb2tzaGVsZi5Nb2RlbC5fX3N1cGVyX18uc2F2ZTtcblxuICAgICAgaWYgKGtleSA9PT0gbnVsbCB8fCBrZXkgPT09IHVuZGVmaW5lZCB8fCB0eXBlb2Yga2V5ID09PSBcIm9iamVjdFwiKSB7XG4gICAgICAgIHJldHVybiBzYXZlLmNhbGwodGhpcywga2V5LCB3aXRoVHJhbnNhY3Rpb24odmFsKSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBzYXZlLmNhbGwodGhpcywga2V5LCB2YWwsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgfSxcbiAgICBkZXN0cm95OiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgcmV0dXJuIGJvb2tzaGVsZi5Nb2RlbC5fX3N1cGVyX18uZGVzdHJveVxuICAgICAgICAuY2FsbCh0aGlzLCB3aXRoVHJhbnNhY3Rpb24ob3B0aW9ucykpO1xuICAgIH0sXG4gICAgZmV0Y2g6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICByZXR1cm4gYm9va3NoZWxmLk1vZGVsLl9fc3VwZXJfXy5mZXRjaFxuICAgICAgICAuY2FsbCh0aGlzLCB3aXRoVHJhbnNhY3Rpb24ob3B0aW9ucykpO1xuICAgIH0sXG4gICAgZmV0Y2hBbGw6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICByZXR1cm4gYm9va3NoZWxmLk1vZGVsLl9fc3VwZXJfXy5mZXRjaEFsbFxuICAgICAgICAuY2FsbCh0aGlzLCB3aXRoVHJhbnNhY3Rpb24ob3B0aW9ucykpO1xuICAgIH0sXG4gICAgbG9hZDogZnVuY3Rpb24gKHJlbGF0aW9ucywgb3B0aW9ucykge1xuICAgICAgcmV0dXJuIGJvb2tzaGVsZi5Nb2RlbC5fX3N1cGVyX18ubG9hZFxuICAgICAgICAuY2FsbCh0aGlzLCByZWxhdGlvbnMsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgfSxcbiAgfSk7XG5cbiAgYm9va3NoZWxmLkNvbGxlY3Rpb24gPSBib29rc2hlbGYuQ29sbGVjdGlvbi5leHRlbmQoe1xuICAgIGF0dGFjaDogZnVuY3Rpb24gKGlkcywgb3B0aW9ucykge1xuICAgICAgcmV0dXJuIGJvb2tzaGVsZi5Db2xsZWN0aW9uLl9fc3VwZXJfXy5hdHRhY2hcbiAgICAgICAgLmNhbGwodGhpcywgaWRzLCB3aXRoVHJhbnNhY3Rpb24ob3B0aW9ucykpO1xuICAgIH0sXG4gICAgZGV0YWNoOiBmdW5jdGlvbiAoaWRzLCBvcHRpb25zKSB7XG4gICAgICByZXR1cm4gYm9va3NoZWxmLkNvbGxlY3Rpb24uX19zdXBlcl9fLmRldGFjaFxuICAgICAgICAuY2FsbCh0aGlzLCBpZHMsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgfSxcbiAgICBjcmVhdGU6IGZ1bmN0aW9uIChtb2RlbCwgb3B0aW9ucykge1xuICAgICAgcmV0dXJuIGJvb2tzaGVsZi5Db2xsZWN0aW9uLl9fc3VwZXJfXy5jcmVhdGVcbiAgICAgICAgLmNhbGwodGhpcywgbW9kZWwsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgfSxcbiAgICBmZXRjaE9uZTogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBib29rc2hlbGYuQ29sbGVjdGlvbi5fX3N1cGVyX18uZmV0Y2hPbmVcbiAgICAgICAgLmNhbGwodGhpcywgd2l0aFRyYW5zYWN0aW9uKG9wdGlvbnMpKTtcbiAgICB9LFxuICAgIGxvYWQ6IGZ1bmN0aW9uIChyZWxhdGlvbnMsIG9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBib29rc2hlbGYuQ29sbGVjdGlvbi5fX3N1cGVyX18ubG9hZFxuICAgICAgICAuY2FsbCh0aGlzLCByZWxhdGlvbnMsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgfSxcbiAgICB1cGRhdGVQaXZvdDogZnVuY3Rpb24gKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBib29rc2hlbGYuQ29sbGVjdGlvbi5fX3N1cGVyX18udXBkYXRlUGl2b3RcbiAgICAgICAgLmNhbGwodGhpcywgYXR0cmlidXRlcywgd2l0aFRyYW5zYWN0aW9uKG9wdGlvbnMpKTtcbiAgICB9LFxuICB9KTtcblxuICBib29rc2hlbGYuX29yaWdpbmFsVHJhbnNhY3Rpb24gPSBib29rc2hlbGYudHJhbnNhY3Rpb247XG5cbiAgYm9va3NoZWxmLnRyYW5zYWN0aW9uID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuX29yaWdpbmFsVHJhbnNhY3Rpb24odHJ4ID0+IChcbiAgICAgIG5zLnJ1bkFuZFJldHVybigoKSA9PiB7XG4gICAgICAgIG5zLnNldChUUkFOU0FDVElPTl9LRVksIHRyeCk7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayh0cngpO1xuICAgICAgfSlcbiAgICApKVxuICB9O1xufTtcbiJdfQ==