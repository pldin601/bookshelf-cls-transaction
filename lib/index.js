'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _continuationLocalStorage = require('continuation-local-storage');

var _continuationLocalStorage2 = _interopRequireDefault(_continuationLocalStorage);

var _clsBluebird = require('cls-bluebird');

var _clsBluebird2 = _interopRequireDefault(_clsBluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var ns = _continuationLocalStorage2.default.createNamespace('bookshelf-sessions');
var TRANSACTION_KEY = 'trx';

var getCurrentTransaction = function getCurrentTransaction() {
  return ns.get(TRANSACTION_KEY);
};

var isUnderTransaction = function isUnderTransaction() {
  return getCurrentTransaction() !== undefined;
};

var withTransaction = function withTransaction() {
  var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

  if (isUnderTransaction()) {
    return _extends({
      transacting: getCurrentTransaction()
    }, options);
  }
  return options;
};

module.exports = function (bookshelf) {
  // Patch Bluebird to work correctly with cls
  (0, _clsBluebird2.default)(ns);

  bookshelf.Model = bookshelf.Model.extend({
    save: function save(key, val, options) {
      var save = bookshelf.Model.__super__.save;

      if (key === null || key === undefined || (typeof key === 'undefined' ? 'undefined' : _typeof(key)) === "object") {
        return save.call(this, key, withTransaction(val));
      }

      return save.call(this, key, val, withTransaction(options));
    },
    destroy: function destroy(options) {
      return bookshelf.Model.__super__.destroy.call(this, withTransaction(options));
    },
    fetch: function fetch(options) {
      return bookshelf.Model.__super__.fetch.call(this, withTransaction(options));
    },
    fetchAll: function fetchAll(options) {
      return bookshelf.Model.__super__.fetchAll.call(this, withTransaction(options));
    },
    load: function load(relations, options) {
      return bookshelf.Model.__super__.load.call(this, relations, withTransaction(options));
    }
  });

  bookshelf.Collection = bookshelf.Collection.extend({
    attach: function attach(ids, options) {
      return bookshelf.Collection.__super__.attach.call(this, ids, withTransaction(options));
    },
    detach: function detach(ids, options) {
      return bookshelf.Collection.__super__.detach.call(this, ids, withTransaction(options));
    },
    create: function create(model, options) {
      return bookshelf.Collection.__super__.create.call(this, model, withTransaction(options));
    },
    fetchOne: function fetchOne(options) {
      return bookshelf.Collection.__super__.fetchOne.call(this, withTransaction(options));
    },
    fetch: function fetch(options) {
      return bookshelf.Collection.__super__.fetch.call(this, withTransaction(options));
    },
    load: function load(relations, options) {
      return bookshelf.Collection.__super__.load.call(this, relations, withTransaction(options));
    },
    updatePivot: function updatePivot(attributes, options) {
      return bookshelf.Collection.__super__.updatePivot.call(this, attributes, withTransaction(options));
    },
    count: function count(column, options) {
      var count = bookshelf.Collection.__super__.count;

      if (!_lodash2.default.isString(column)) {
        return count.call(this, withTransaction(options));
      }

      return count.call(this, column, withTransaction(options));
    }
  });

  bookshelf._originalTransaction = bookshelf.transaction;

  bookshelf.transaction = function (callback) {
    return this._originalTransaction(function (trx) {
      return ns.runAndReturn(function () {
        ns.set(TRANSACTION_KEY, trx);
        return callback(trx);
      });
    });
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJucyIsImNyZWF0ZU5hbWVzcGFjZSIsIlRSQU5TQUNUSU9OX0tFWSIsImdldEN1cnJlbnRUcmFuc2FjdGlvbiIsImdldCIsImlzVW5kZXJUcmFuc2FjdGlvbiIsInVuZGVmaW5lZCIsIndpdGhUcmFuc2FjdGlvbiIsIm9wdGlvbnMiLCJ0cmFuc2FjdGluZyIsIm1vZHVsZSIsImV4cG9ydHMiLCJib29rc2hlbGYiLCJNb2RlbCIsImV4dGVuZCIsInNhdmUiLCJrZXkiLCJ2YWwiLCJfX3N1cGVyX18iLCJjYWxsIiwiZGVzdHJveSIsImZldGNoIiwiZmV0Y2hBbGwiLCJsb2FkIiwicmVsYXRpb25zIiwiQ29sbGVjdGlvbiIsImF0dGFjaCIsImlkcyIsImRldGFjaCIsImNyZWF0ZSIsIm1vZGVsIiwiZmV0Y2hPbmUiLCJ1cGRhdGVQaXZvdCIsImF0dHJpYnV0ZXMiLCJjb3VudCIsImNvbHVtbiIsImlzU3RyaW5nIiwiX29yaWdpbmFsVHJhbnNhY3Rpb24iLCJ0cmFuc2FjdGlvbiIsImNhbGxiYWNrIiwicnVuQW5kUmV0dXJuIiwic2V0IiwidHJ4Il0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVBLElBQU1BLEtBQUssbUNBQUlDLGVBQUosQ0FBb0Isb0JBQXBCLENBQVg7QUFDQSxJQUFNQyxrQkFBa0IsS0FBeEI7O0FBRUEsSUFBTUMsd0JBQXdCLFNBQXhCQSxxQkFBd0I7QUFBQSxTQUFNSCxHQUFHSSxHQUFILENBQU9GLGVBQVAsQ0FBTjtBQUFBLENBQTlCOztBQUVBLElBQU1HLHFCQUFxQixTQUFyQkEsa0JBQXFCO0FBQUEsU0FBTUYsNEJBQTRCRyxTQUFsQztBQUFBLENBQTNCOztBQUVBLElBQU1DLGtCQUFrQixTQUFsQkEsZUFBa0IsR0FBa0I7QUFBQSxNQUFqQkMsT0FBaUIsdUVBQVAsRUFBTzs7QUFDeEMsTUFBSUgsb0JBQUosRUFBMEI7QUFDeEI7QUFDRUksbUJB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VTBCLFdBQTNDOztBQUVBMUIsWUFBVTBCLFdBQVYsR0FBd0IsVUFBVUMsUUFBVixFQUFvQjtBQUMxQyxXQUFPLEtBQUtGLG9CQUFMLENBQTBCO0FBQUEsYUFDL0JyQyxHQUFHd0MsWUFBSCxDQUFnQixZQUFNO0FBQ3BCeEMsV0FBR3lDLEdBQUgsQ0FBT3ZDLGVBQVAsRUFBd0J3QyxHQUF4QjtBQUNBLGVBQU9ILFNBQVNHLEdBQVQsQ0FBUDtBQUNELE9BSEQsQ0FEK0I7QUFBQSxLQUExQixDQUFQO0FBTUQsR0FQRDtBQVFELENBbEZEIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNscyBmcm9tICdjb250aW51YXRpb24tbG9jYWwtc3RvcmFnZSc7XG5pbXBvcnQgY2xzQmx1ZWJpcmQgZnJvbSAgJ2Nscy1ibHVlYmlyZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5jb25zdCBucyA9IGNscy5jcmVhdGVOYW1lc3BhY2UoJ2Jvb2tzaGVsZi1zZXNzaW9ucycpO1xuY29uc3QgVFJBTlNBQ1RJT05fS0VZID0gJ3RyeCc7XG5cbmNvbnN0IGdldEN1cnJlbnRUcmFuc2FjdGlvbiA9ICgpID0+IG5zLmdldChUUkFOU0FDVElPTl9LRVkpO1xuXG5jb25zdCBpc1VuZGVyVHJhbnNhY3Rpb24gPSAoKSA9PiBnZXRDdXJyZW50VHJhbnNhY3Rpb24oKSAhPT0gdW5kZWZpbmVkO1xuXG5jb25zdCB3aXRoVHJhbnNhY3Rpb24gPSAob3B0aW9ucyA9IHt9KSA9PiB7XG4gIGlmIChpc1VuZGVyVHJhbnNhY3Rpb24oKSkge1xuICAgIHJldHVybiB7XG4gICAgICB0cmFuc2FjdGluZzogZ2V0Q3VycmVudFRyYW5zYWN0aW9uKCksXG4gICAgICAuLi5vcHRpb25zLFxuICAgIH07XG4gIH1cbiAgcmV0dXJuIG9wdGlvbnM7XG59O1xuXG5cbm1vZHVsZS5leHBvcnRzID0gKGJvb2tzaGVsZikgPT4ge1xuICAvLyBQYXRjaCBCbHVlYmlyZCB0byB3b3JrIGNvcnJlY3RseSB3aXRoIGNsc1xuICBjbHNCbHVlYmlyZChucyk7XG5cbiAgYm9va3NoZWxmLk1vZGVsID0gYm9va3NoZWxmLk1vZGVsLmV4dGVuZCh7XG4gICAgc2F2ZTogZnVuY3Rpb24gKGtleSwgdmFsLCBvcHRpb25zKSB7XG4gICAgICBjb25zdCBzYXZlID0gYm9va3NoZWxmLk1vZGVsLl9fc3VwZXJfXy5zYXZlO1xuXG4gICAgICBpZiAoa2V5ID09PSBudWxsIHx8IGtleSA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiBrZXkgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgcmV0dXJuIHNhdmUuY2FsbCh0aGlzLCBrZXksIHdpdGhUcmFuc2FjdGlvbih2YWwpKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHNhdmUuY2FsbCh0aGlzLCBrZXksIHZhbCwgd2l0aFRyYW5zYWN0aW9uKG9wdGlvbnMpKTtcbiAgICB9LFxuICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICByZXR1cm4gYm9va3NoZWxmLk1vZGVsLl9fc3VwZXJfXy5kZXN0cm95XG4gICAgICAgIC5jYWxsKHRoaXMsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgfSxcbiAgICBmZXRjaDogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBib29rc2hlbGYuTW9kZWwuX19zdXBlcl9fLmZldGNoXG4gICAgICAgIC5jYWxsKHRoaXMsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgfSxcbiAgICBmZXRjaEFsbDogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBib29rc2hlbGYuTW9kZWwuX19zdXBlcl9fLmZldGNoQWxsXG4gICAgICAgIC5jYWxsKHRoaXMsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgfSxcbiAgICBsb2FkOiBmdW5jdGlvbiAocmVsYXRpb25zLCBvcHRpb25zKSB7XG4gICAgICByZXR1cm4gYm9va3NoZWxmLk1vZGVsLl9fc3VwZXJfXy5sb2FkXG4gICAgICAgIC5jYWxsKHRoaXMsIHJlbGF0aW9ucywgd2l0aFRyYW5zYWN0aW9uKG9wdGlvbnMpKTtcbiAgICB9LFxuICB9KTtcblxuICBib29rc2hlbGYuQ29sbGVjdGlvbiA9IGJvb2tzaGVsZi5Db2xsZWN0aW9uLmV4dGVuZCh7XG4gICAgYXR0YWNoOiBmdW5jdGlvbiAoaWRzLCBvcHRpb25zKSB7XG4gICAgICByZXR1cm4gYm9va3NoZWxmLkNvbGxlY3Rpb24uX19zdXBlcl9fLmF0dGFjaFxuICAgICAgICAuY2FsbCh0aGlzLCBpZHMsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgfSxcbiAgICBkZXRhY2g6IGZ1bmN0aW9uIChpZHMsIG9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBib29rc2hlbGYuQ29sbGVjdGlvbi5fX3N1cGVyX18uZGV0YWNoXG4gICAgICAgIC5jYWxsKHRoaXMsIGlkcywgd2l0aFRyYW5zYWN0aW9uKG9wdGlvbnMpKTtcbiAgICB9LFxuICAgIGNyZWF0ZTogZnVuY3Rpb24gKG1vZGVsLCBvcHRpb25zKSB7XG4gICAgICByZXR1cm4gYm9va3NoZWxmLkNvbGxlY3Rpb24uX19zdXBlcl9fLmNyZWF0ZVxuICAgICAgICAuY2FsbCh0aGlzLCBtb2RlbCwgd2l0aFRyYW5zYWN0aW9uKG9wdGlvbnMpKTtcbiAgICB9LFxuICAgIGZldGNoT25lOiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgcmV0dXJuIGJvb2tzaGVsZi5Db2xsZWN0aW9uLl9fc3VwZXJfXy5mZXRjaE9uZVxuICAgICAgICAuY2FsbCh0aGlzLCB3aXRoVHJhbnNhY3Rpb24ob3B0aW9ucykpO1xuICAgIH0sXG4gICAgZmV0Y2g6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICByZXR1cm4gYm9va3NoZWxmLkNvbGxlY3Rpb24uX19zdXBlcl9fLmZldGNoXG4gICAgICAgIC5jYWxsKHRoaXMsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgfSxcbiAgICBsb2FkOiBmdW5jdGlvbiAocmVsYXRpb25zLCBvcHRpb25zKSB7XG4gICAgICByZXR1cm4gYm9va3NoZWxmLkNvbGxlY3Rpb24uX19zdXBlcl9fLmxvYWRcbiAgICAgICAgLmNhbGwodGhpcywgcmVsYXRpb25zLCB3aXRoVHJhbnNhY3Rpb24ob3B0aW9ucykpO1xuICAgIH0sXG4gICAgdXBkYXRlUGl2b3Q6IGZ1bmN0aW9uIChhdHRyaWJ1dGVzLCBvcHRpb25zKSB7XG4gICAgICByZXR1cm4gYm9va3NoZWxmLkNvbGxlY3Rpb24uX19zdXBlcl9fLnVwZGF0ZVBpdm90XG4gICAgICAgIC5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgfSxcbiAgICBjb3VudDogZnVuY3Rpb24gKGNvbHVtbiwgb3B0aW9ucykge1xuICAgICAgY29uc3QgY291bnQgPSBib29rc2hlbGYuQ29sbGVjdGlvbi5fX3N1cGVyX18uY291bnQ7XG5cbiAgICAgIGlmICghXy5pc1N0cmluZyhjb2x1bW4pKSB7XG4gICAgICAgIHJldHVybiBjb3VudC5jYWxsKHRoaXMsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBjb3VudC5jYWxsKHRoaXMsIGNvbHVtbiwgd2l0aFRyYW5zYWN0aW9uKG9wdGlvbnMpKTtcbiAgICB9LFxuICB9KTtcblxuICBib29rc2hlbGYuX29yaWdpbmFsVHJhbnNhY3Rpb24gPSBib29rc2hlbGYudHJhbnNhY3Rpb247XG5cbiAgYm9va3NoZWxmLnRyYW5zYWN0aW9uID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuX29yaWdpbmFsVHJhbnNhY3Rpb24odHJ4ID0+IChcbiAgICAgIG5zLnJ1bkFuZFJldHVybigoKSA9PiB7XG4gICAgICAgIG5zLnNldChUUkFOU0FDVElPTl9LRVksIHRyeCk7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayh0cngpO1xuICAgICAgfSlcbiAgICApKVxuICB9O1xufTtcbiJdfQ==