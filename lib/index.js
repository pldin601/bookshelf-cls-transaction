'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var cls = require('continuation-local-storage');
var clsBluebird = require('cls-bluebird');

var ns = cls.createNamespace('bookshelf-sessions');
var TRANSACTION_KEY = 'trx';

var getCurrentTransaction = function getCurrentTransaction() {
  return ns.get(TRANSACTION_KEY);
};

var isUnderTransaction = function isUnderTransaction() {
  return getCurrentTransaction() !== undefined;
};

var withTransaction = function withTransaction() {
  var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

  if (isUnderTransaction()) {
    return _extends({
      transacting: getCurrentTransaction()
    }, options);
  }
  return options;
};

module.exports = function (bookshelf) {
  // Patch Bluebird to work correctly with cls
  clsBluebird(ns);

  bookshelf.Model = bookshelf.Model.extend({
    save: function save(key, val, options) {
      var save = bookshelf.Model.__super__.save;

      if (key === null || key === undefined || (typeof key === 'undefined' ? 'undefined' : _typeof(key)) === "object") {
        return save.call(this, key, withTransaction(val));
      }

      return save.call(this, key, val, withTransaction(options));
    },
    destroy: function destroy(options) {
      return bookshelf.Model.__super__.destroy.call(this, withTransaction(options));
    },
    fetch: function fetch(options) {
      return bookshelf.Model.__super__.fetch.call(this, withTransaction(options));
    },
    fetchAll: function fetchAll(options) {
      return bookshelf.Model.__super__.fetchAll.call(this, withTransaction(options));
    },
    load: function load(relations, options) {
      return bookshelf.Model.__super__.load.call(this, relations, withTransaction(options));
    }
  });

  bookshelf.Collection = bookshelf.Collection.extend({
    attach: function attach(ids, options) {
      return bookshelf.Collection.__super__.attach.call(this, ids, withTransaction(options));
    },
    detach: function detach(ids, options) {
      return bookshelf.Collection.__super__.detach.call(this, ids, withTransaction(options));
    },
    create: function create(model, options) {
      return bookshelf.Collection.__super__.create.call(this, model, withTransaction(options));
    },
    fetchOne: function fetchOne(options) {
      return bookshelf.Collection.__super__.fetchOne.call(this, withTransaction(options));
    },
    load: function load(relations, options) {
      return bookshelf.Collection.__super__.load.call(this, relations, withTransaction(options));
    },
    updatePivot: function updatePivot(attributes, options) {
      return bookshelf.Collection.__super__.updatePivot.call(this, attributes, withTransaction(options));
    }
  });

  // bookshelf._originalTransaction = bookshelf.transaction;
  bookshelf._originalTransaction = function (cb) {
    return cb('foo');
  };

  bookshelf.transaction = function (callback) {
    return this._originalTransaction(function (trx) {
      return ns.runAndReturn(function () {
        ns.set(TRANSACTION_KEY, trx);
        return callback(trx);
      });
    });
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJjbHMiLCJyZXF1aXJlIiwiY2xzQmx1ZWJpcmQiLCJucyIsImNyZWF0ZU5hbWVzcGFjZSIsIlRSQU5TQUNUSU9OX0tFWSIsImdldEN1cnJlbnRUcmFuc2FjdGlvbiIsImdldCIsImlzVW5kZXJUcmFuc2FjdGlvbiIsInVuZGVmaW5lZCIsIndpdGhUcmFuc2FjdGlvbiIsIm9wdGlvbnMiLCJ0cmFuc2FjdGluZyIsIm1vZHVsZSIsImV4cG9ydHMiLCJib29rc2hlbGYiLCJNb2RlbCIsImV4dGVuZCIsInNhdmUiLCJrZXkiLCJ2YWwiLCJfX3N1cGVyX18iLCJjYWxsIiwiZGVzdHJveSIsImZldGNoIiwiZmV0Y2hBbGwiLCJsb2FkIiwicmVsYXRpb25zIiwiQ29sbGVjdGlvbiIsImF0dGFjaCIsImlkcyIsImRldGFjaCIsImNyZWF0ZSIsIm1vZGVsIiwiZmV0Y2hPbmUiLCJ1cGRhdGVQaXZvdCIsImF0dHJpYnV0ZXMiLCJfb3JpZ2luYWxUcmFuc2FjdGlvbiIsImNiIiwidHJhbnNhY3Rpb24iLCJjYWxsYmFjayIsInJ1bkFuZFJldHVybiIsInNldCIsInRyeCJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBTUEsTUFBTUMsUUFBUSw0QkFBUixDQUFaO0FBQ0EsSUFBTUMsY0FBY0QsUUFBUSxjQUFSLENBQXBCOztBQUVBLElBQU1FLEtBQUtILElBQUlJLGVBQUosQ0FBb0Isb0JBQXBCLENBQVg7QUFDQSxJQUFNQyxrQkFBa0IsS0FBeEI7O0FBRUEsSUFBTUMsd0JBQXdCLFNBQXhCQSxxQkFBd0I7QUFBQSxTQUFNSCxHQUFHSSxHQUFILENBQU9GLGVBQVAsQ0FBTjtBQUFBLENBQTlCOztBQUVBLElBQU1HLHFCQUFxQixTQUFyQkEsa0JBQXFCO0FBQUEsU0FBTUYsNEJBQTRCRyxTQUFsQztBQUFBLENBQTNCOztBQUVBLElBQU1DLGtCQUFrQixTQUFsQkEsZUFBa0IsR0FBa0I7QUFBQSxNQUFqQkMsT0FBaUIsdUVB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T0ksVUFBVWEsVUFBVixDQUFxQlAsU0FBckIsQ0FBK0JhLFFBQS9CLENBQ0paLElBREksQ0FDQyxJQURELEVBQ09aLGdCQUFnQkMsT0FBaEIsQ0FEUCxDQUFQO0FBRUQsS0FoQmdEO0FBaUJqRGUsVUFBTSxjQUFVQyxTQUFWLEVBQXFCaEIsT0FBckIsRUFBOEI7QUFDbEMsYUFBT0ksVUFBVWEsVUFBVixDQUFxQlAsU0FBckIsQ0FBK0JLLElBQS9CLENBQ0pKLElBREksQ0FDQyxJQURELEVBQ09LLFNBRFAsRUFDa0JqQixnQkFBZ0JDLE9BQWhCLENBRGxCLENBQVA7QUFFRCxLQXBCZ0Q7QUFxQmpEd0IsaUJBQWEscUJBQVVDLFVBQVYsRUFBc0J6QixPQUF0QixFQUErQjtBQUMxQyxhQUFPSSxVQUFVYSxVQUFWLENBQXFCUCxTQUFyQixDQUErQmMsV0FBL0IsQ0FDSmIsSUFESSxDQUNDLElBREQsRUFDT2MsVUFEUCxFQUNtQjFCLGdCQUFnQkMsT0FBaEIsQ0FEbkIsQ0FBUDtBQUVEO0FBeEJnRCxHQUE1QixDQUF2Qjs7QUEyQkE7QUFDQUksWUFBVXNCLG9CQUFWLEdBQWlDLFVBQUNDLEVBQUQ7QUFBQSxXQUFRQSxHQUFHLEtBQUgsQ0FBUjtBQUFBLEdBQWpDOztBQUVBdkIsWUFBVXdCLFdBQVYsR0FBd0IsVUFBVUMsUUFBVixFQUFvQjtBQUMxQyxXQUFPLEtBQUtILG9CQUFMLENBQTBCO0FBQUEsYUFDL0JsQyxHQUFHc0MsWUFBSCxDQUFnQixZQUFNO0FBQ3BCdEMsV0FBR3VDLEdBQUgsQ0FBT3JDLGVBQVAsRUFBd0JzQyxHQUF4QjtBQUNBLGVBQU9ILFNBQVNHLEdBQVQsQ0FBUDtBQUNELE9BSEQsQ0FEK0I7QUFBQSxLQUExQixDQUFQO0FBTUQsR0FQRDtBQVFELENBdEVEIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgY2xzID0gcmVxdWlyZSgnY29udGludWF0aW9uLWxvY2FsLXN0b3JhZ2UnKTtcbmNvbnN0IGNsc0JsdWViaXJkID0gcmVxdWlyZSgnY2xzLWJsdWViaXJkJyk7XG5cbmNvbnN0IG5zID0gY2xzLmNyZWF0ZU5hbWVzcGFjZSgnYm9va3NoZWxmLXNlc3Npb25zJyk7XG5jb25zdCBUUkFOU0FDVElPTl9LRVkgPSAndHJ4JztcblxuY29uc3QgZ2V0Q3VycmVudFRyYW5zYWN0aW9uID0gKCkgPT4gbnMuZ2V0KFRSQU5TQUNUSU9OX0tFWSk7XG5cbmNvbnN0IGlzVW5kZXJUcmFuc2FjdGlvbiA9ICgpID0+IGdldEN1cnJlbnRUcmFuc2FjdGlvbigpICE9PSB1bmRlZmluZWQ7XG5cbmNvbnN0IHdpdGhUcmFuc2FjdGlvbiA9IChvcHRpb25zID0ge30pID0+IHtcbiAgaWYgKGlzVW5kZXJUcmFuc2FjdGlvbigpKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRyYW5zYWN0aW5nOiBnZXRDdXJyZW50VHJhbnNhY3Rpb24oKSxcbiAgICAgIC4uLm9wdGlvbnMsXG4gICAgfTtcbiAgfVxuICByZXR1cm4gb3B0aW9ucztcbn07XG5cblxubW9kdWxlLmV4cG9ydHMgPSAoYm9va3NoZWxmKSA9PiB7XG4gIC8vIFBhdGNoIEJsdWViaXJkIHRvIHdvcmsgY29ycmVjdGx5IHdpdGggY2xzXG4gIGNsc0JsdWViaXJkKG5zKTtcblxuICBib29rc2hlbGYuTW9kZWwgPSBib29rc2hlbGYuTW9kZWwuZXh0ZW5kKHtcbiAgICBzYXZlOiBmdW5jdGlvbiAoa2V5LCB2YWwsIG9wdGlvbnMpIHtcbiAgICAgIGNvbnN0IHNhdmUgPSBib29rc2hlbGYuTW9kZWwuX19zdXBlcl9fLnNhdmU7XG5cbiAgICAgIGlmIChrZXkgPT09IG51bGwgfHwga2V5ID09PSB1bmRlZmluZWQgfHwgdHlwZW9mIGtleSA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICByZXR1cm4gc2F2ZS5jYWxsKHRoaXMsIGtleSwgd2l0aFRyYW5zYWN0aW9uKHZhbCkpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gc2F2ZS5jYWxsKHRoaXMsIGtleSwgdmFsLCB3aXRoVHJhbnNhY3Rpb24ob3B0aW9ucykpO1xuICAgIH0sXG4gICAgZGVzdHJveTogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBib29rc2hlbGYuTW9kZWwuX19zdXBlcl9fLmRlc3Ryb3lcbiAgICAgICAgLmNhbGwodGhpcywgd2l0aFRyYW5zYWN0aW9uKG9wdGlvbnMpKTtcbiAgICB9LFxuICAgIGZldGNoOiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgcmV0dXJuIGJvb2tzaGVsZi5Nb2RlbC5fX3N1cGVyX18uZmV0Y2hcbiAgICAgICAgLmNhbGwodGhpcywgd2l0aFRyYW5zYWN0aW9uKG9wdGlvbnMpKTtcbiAgICB9LFxuICAgIGZldGNoQWxsOiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgcmV0dXJuIGJvb2tzaGVsZi5Nb2RlbC5fX3N1cGVyX18uZmV0Y2hBbGxcbiAgICAgICAgLmNhbGwodGhpcywgd2l0aFRyYW5zYWN0aW9uKG9wdGlvbnMpKTtcbiAgICB9LFxuICAgIGxvYWQ6IGZ1bmN0aW9uIChyZWxhdGlvbnMsIG9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBib29rc2hlbGYuTW9kZWwuX19zdXBlcl9fLmxvYWRcbiAgICAgICAgLmNhbGwodGhpcywgcmVsYXRpb25zLCB3aXRoVHJhbnNhY3Rpb24ob3B0aW9ucykpO1xuICAgIH0sXG4gIH0pO1xuXG4gIGJvb2tzaGVsZi5Db2xsZWN0aW9uID0gYm9va3NoZWxmLkNvbGxlY3Rpb24uZXh0ZW5kKHtcbiAgICBhdHRhY2g6IGZ1bmN0aW9uIChpZHMsIG9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBib29rc2hlbGYuQ29sbGVjdGlvbi5fX3N1cGVyX18uYXR0YWNoXG4gICAgICAgIC5jYWxsKHRoaXMsIGlkcywgd2l0aFRyYW5zYWN0aW9uKG9wdGlvbnMpKTtcbiAgICB9LFxuICAgIGRldGFjaDogZnVuY3Rpb24gKGlkcywgb3B0aW9ucykge1xuICAgICAgcmV0dXJuIGJvb2tzaGVsZi5Db2xsZWN0aW9uLl9fc3VwZXJfXy5kZXRhY2hcbiAgICAgICAgLmNhbGwodGhpcywgaWRzLCB3aXRoVHJhbnNhY3Rpb24ob3B0aW9ucykpO1xuICAgIH0sXG4gICAgY3JlYXRlOiBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMpIHtcbiAgICAgIHJldHVybiBib29rc2hlbGYuQ29sbGVjdGlvbi5fX3N1cGVyX18uY3JlYXRlXG4gICAgICAgIC5jYWxsKHRoaXMsIG1vZGVsLCB3aXRoVHJhbnNhY3Rpb24ob3B0aW9ucykpO1xuICAgIH0sXG4gICAgZmV0Y2hPbmU6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICByZXR1cm4gYm9va3NoZWxmLkNvbGxlY3Rpb24uX19zdXBlcl9fLmZldGNoT25lXG4gICAgICAgIC5jYWxsKHRoaXMsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgfSxcbiAgICBsb2FkOiBmdW5jdGlvbiAocmVsYXRpb25zLCBvcHRpb25zKSB7XG4gICAgICByZXR1cm4gYm9va3NoZWxmLkNvbGxlY3Rpb24uX19zdXBlcl9fLmxvYWRcbiAgICAgICAgLmNhbGwodGhpcywgcmVsYXRpb25zLCB3aXRoVHJhbnNhY3Rpb24ob3B0aW9ucykpO1xuICAgIH0sXG4gICAgdXBkYXRlUGl2b3Q6IGZ1bmN0aW9uIChhdHRyaWJ1dGVzLCBvcHRpb25zKSB7XG4gICAgICByZXR1cm4gYm9va3NoZWxmLkNvbGxlY3Rpb24uX19zdXBlcl9fLnVwZGF0ZVBpdm90XG4gICAgICAgIC5jYWxsKHRoaXMsIGF0dHJpYnV0ZXMsIHdpdGhUcmFuc2FjdGlvbihvcHRpb25zKSk7XG4gICAgfSxcbiAgfSk7XG5cbiAgLy8gYm9va3NoZWxmLl9vcmlnaW5hbFRyYW5zYWN0aW9uID0gYm9va3NoZWxmLnRyYW5zYWN0aW9uO1xuICBib29rc2hlbGYuX29yaWdpbmFsVHJhbnNhY3Rpb24gPSAoY2IpID0+IGNiKCdmb28nKTtcblxuICBib29rc2hlbGYudHJhbnNhY3Rpb24gPSBmdW5jdGlvbiAoY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5fb3JpZ2luYWxUcmFuc2FjdGlvbih0cnggPT4gKFxuICAgICAgbnMucnVuQW5kUmV0dXJuKCgpID0+IHtcbiAgICAgICAgbnMuc2V0KFRSQU5TQUNUSU9OX0tFWSwgdHJ4KTtcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHRyeCk7XG4gICAgICB9KVxuICAgICkpXG4gIH07XG59O1xuIl19